name: 'ai'
version: '3.8'

# ============================================================================
# MCP Servers & Qdrant Vector Database Services
# ============================================================================

services:
  github-mcp-server:
    image: ghcr.io/github/github-mcp-server
    container_name: github-mcp-server
    environment:
      MCP_SERVER_NAME: github
      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_TOKEN}
    ports:
      - "3001:3000"
    volumes:
      - mcp-github-data:/data
    restart: always
    networks:
      - cmnw

  mcp-grafana:
    container_name: mcp-grafana
    image: mcp/grafana:latest
    restart: always
    environment:
      GRAFANA_URL: ${GRAFANA_URL}
      GRAFANA_SERVICE_ACCOUNT_TOKEN: ${GRAFANA_SERVICE_ACCOUNT_TOKEN}
    ports:
      - "8001:8001"
    command: ["--transport", "sse", "--address", "0.0.0.0:8001"]
    networks:
      - cmnw

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: always
    ports:
      - "6333:6333"      # REST API
      - "6334:6334"      # gRPC API
    environment:
      QDRANT_API_KEY: ${QDRANT_API_KEY}
      QDRANT_READ_ONLY_API_KEY: ${QDRANT_READ_ONLY_API_KEY}
      QDRANT_TELEMETRY_DISABLED: ${QDRANT_TELEMETRY_DISABLED}
      QDRANT_LOG_LEVEL: ${QDRANT_LOG_LEVEL}
    volumes:
      - qdrant:/qdrant
    networks:
      - cmnw
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # Ollama - Embedding Service with mxbai-embed-large
  # ============================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    ports:
      - "11434:11434"    # Ollama API endpoint
    environment:
      OLLAMA_HOST: ${OLLAMA_HOST}
    volumes:
      - ollama:/root/.ollama
    networks:
      - cmnw
    security_opt:
      - no-new-privileges:true

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: always
    ports:
      - "3000:8080"      # Web UI
    environment:
      OLLAMA_BASE_URL: http://ollama:11434
      WEBUI_AUTH: ${WEBUI_AUTH}
    volumes:
      - open-webui:/app/backend/data
    networks:
      - cmnw
    depends_on:
      - ollama
    security_opt:
      - no-new-privileges:true

# ============================================================================
# Named Volumes
# ============================================================================
volumes:
  mcp-github-data:
    driver: local

  qdrant:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '/mnt/qdrant'

  ollama:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '/mnt/ollama'

# ============================================================================
# Networks
# ============================================================================
networks:
  cmnw:
    external: true
