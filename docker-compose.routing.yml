name: "routing"
version: '3.8'
services:
    portainer:
        image: portainer/portainer-ce:lts
        container_name: portainer
        restart: always
        ports:
            - "8000:8000"
            - "9443:9443"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - portainer_data:/data
        environment:
            - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        networks:
            - bridge
        labels:
            - "com.docker.desktop.extension.api.version=>= 0.2.2"
            - "com.docker.desktop.extension.icon=https://raw.githubusercontent.com/alexzedim/core/refs/heads/master/icons/cmnw-logo.png"
            - "io.portainer.server=true"
            - "org.opencontainers.image.description=Docker container management made simple, with the world's most popular GUI-based container management platform."
            - "org.opencontainers.image.title=Portainer"
            - "org.opencontainers.image.vendor=Portainer.io"
            - "traefik.enable=true"
            - "traefik.http.routers.control.rule=Host(`control.cmnw.ru`)"
            - "traefik.http.routers.control.entrypoints=web,websecure"
            - "traefik.http.routers.control.tls=true"
            - "traefik.http.routers.control.tls.certresolver=letsencrypt"
            - "traefik.http.services.control.loadbalancer.server.port=9443"

    traefik:
        image: traefik:v3.4
        container_name: traefik
        restart: always
        environment:
            - TZ=${TZ}
        command:
            # API and Dashboard
            - "--api.dashboard=true"
            - "--api.insecure=false"

            # Entry Points
            - "--entrypoints.web.address=:80"
            - "--entrypoints.websecure.address=:443"

            # HTTP to HTTPS redirect
            - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
            - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

            # Providers
            - "--providers.docker=true"
            - "--providers.docker.exposedbydefault=false"

            # Let's Encrypt
            - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
            - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
            - "--certificatesresolvers.letsencrypt.acme.email=alexzedim@gmail.com"
            - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

            # Global settings
            - "--global.checknewversion=false"
            - "--global.sendanonymoususage=false"

            # Logging (optional)
            - "--log.level=INFO"
        ports:
            - '80:80'
            - '443:443'
            - '5000:8080'
        volumes:
            # Mount entire traefik config directory
            # Changed to rw for ACME storage
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - traefik-letsencrypt:/letsencrypt
        labels:
            - "traefik.enable=true"
            # Dashboard configuration
            - "traefik.http.routers.traefik.rule=Host(`traefik.cmnw.ru`)"
            - "traefik.http.routers.traefik.entrypoints=websecure"
            - "traefik.http.routers.traefik.tls=true"
            - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
            - "traefik.http.routers.traefik.service=api@internal"
        networks:
            - traefik

volumes:
    traefik-letsencrypt:
    portainer_data:
        external: true

networks:
    bridge:
        external: true
    traefik:
        external: true

