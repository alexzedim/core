name: "routing"
version: '3.8'
services:
    traefik:
        image: traefik:v3.4
        container_name: traefik
        restart: always
        environment:
            - TZ=${TZ}
            - TRAEFIK_AUTH=${TRAEFIK_AUTH}
            - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
            - TRAEFIK_DOMAIN=${TRAEFIK_DOMAIN}
        command:
            # API and Dashboard
            - "--api.dashboard=true"
            - "--api.insecure=false"

            # Entry Points
            - "--entrypoints.web.address=:80"
            - "--entrypoints.websecure.address=:443"

            # HTTP to HTTPS redirect
            - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
            - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

            # Providers
            - "--providers.docker=true"
            - "--providers.docker.exposedbydefault=false"

            # Let's Encrypt
            - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
            - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
            - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}"
            - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

            # Global settings
            - "--global.checknewversion=false"
            - "--global.sendanonymoususage=false"

            # Logging (optional)
            - "--log.level=INFO"

            # Prometheus Metrics
            - "--metrics.prometheus=true"
            - "--metrics.prometheus.addEntryPointsLabels=true"
            - "--metrics.prometheus.addServicesLabels=true"
            - "--metrics.prometheus.addRoutersLabels=true"
            - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
        ports:
            - '80:80'
            - '443:443'
            - '5000:8080'
            - '8082:8082'  # Prometheus metrics port
        volumes:
            # Mount entire traefik config directory
            # Changed to rw for ACME storage
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - traefik-letsencrypt:/letsencrypt
        labels:
            - "traefik.enable=true"
            # Dashboard configuration
            - "traefik.http.routers.traefik.rule=Host(`${TRAEFIK_DOMAIN}`)"
            - "traefik.http.routers.traefik.entrypoints=websecure"
            - "traefik.http.routers.traefik.tls=true"
            - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
            - "traefik.http.routers.traefik.service=api@internal"
            # Basic Auth middleware
            - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_AUTH}"
            - "traefik.http.routers.traefik.middlewares=auth"
        networks:
            - traefik

volumes:
    traefik-letsencrypt:

networks:
    bridge:
        external: true
