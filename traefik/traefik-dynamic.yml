# traefik-dynamic.yml - Enhanced dynamic configuration
http:
    routers:
        # Traefik Dashboard Router
        traefik-dashboard:
            rule: "Host(`traefik.cmnw.ru`)"
            entryPoints:
                - websecure
            service: api@internal
            middlewares:
                - traefik-auth
                - security-headers
            tls:
                certResolver: letsencrypt
                domains:
                    - main: "cmnw.ru"
                      sans:
                          - "*.cmnw.ru"

        # Grafana Router
        grafana:
            rule: "Host(`grafana.cmnw.ru`)"
            entryPoints:
                - websecure
            service: grafana
            middlewares:
                - security-headers
            tls:
                certResolver: letsencrypt

        # Portainer Router
        portainer:
            rule: "Host(`control.cmnw.ru`)"
            entryPoints:
                - websecure
            service: portainer
            middlewares:
                - security-headers
            tls:
                certResolver: letsencrypt

        # MinIO API Router
        minio-api:
            rule: "Host(`s3.cmnw.ru`)"
            entryPoints:
                - websecure
            service: minio-api
            middlewares:
                - security-headers
            tls:
                certResolver: letsencrypt

        # MinIO Console Router
        minio-console:
            rule: "Host(`console-s3.cmnw.ru`)"
            entryPoints:
                - websecure
            service: minio-console
            middlewares:
                - security-headers
            tls:
                certResolver: letsencrypt

        # Home Assistant Router
        home-assistant:
            rule: "Host(`home.cmnw.ru`)"
            entryPoints:
                - websecure
            service: home-assistant
            middlewares:
                - home-assistant-headers
                - security-headers
            tls:
                certResolver: letsencrypt

        # Node-RED Router
        nodered:
            rule: "Host(`nodered.cmnw.ru`)"
            entryPoints:
                - websecure
            service: nodered
            middlewares:
                - node-red-auth
                - security-headers
            tls:
                certResolver: letsencrypt

        # Prometheus Router (optional, for monitoring)
        prometheus:
            rule: "Host(`prometheus.cmnw.ru`)"
            entryPoints:
                - websecure
            service: prometheus
            middlewares:
                - traefik-auth
                - security-headers
            tls:
                certResolver: letsencrypt

    services:
        # Grafana Service
        grafana:
            loadBalancer:
                servers:
                    - url: "http://grafana:3000"
                healthCheck:
                    path: /api/health
                    interval: 30s
                    timeout: 5s

        # Portainer Service
        portainer:
            loadBalancer:
                servers:
                    - url: "http://portainer:9000"
                healthCheck:
                    path: /api/system/status
                    interval: 30s

        # MinIO API Service
        minio-api:
            loadBalancer:
                servers:
                    - url: "http://minio:9000"
                healthCheck:
                    path: /minio/health/live
                    interval: 30s

        # MinIO Console Service
        minio-console:
            loadBalancer:
                servers:
                    - url: "http://minio:9001"

        # Home Assistant Service
        home-assistant:
            loadBalancer:
                servers:
                    - url: "http://home-assistant:8123"
                healthCheck:
                    path: /api/
                    interval: 30s

        # Node-RED Service
        node-red:
            loadBalancer:
                servers:
                    - url: "http://node-red:1880"

        # Prometheus Service
        prometheus:
            loadBalancer:
                servers:
                    - url: "http://prometheus:9090"
                healthCheck:
                    path: /-/healthy
                    interval: 30s

    middlewares:
        # Traefik Dashboard auth
        traefik-auth:
            basicAuth:
                users:
                    # Generate with: echo $(htpasswd -nb admin yourpassword) | sed -e s/\\$/\\$\\$/g
                    - "traefik:$2y$05$6aIIml9lzHJN1mG/ZYwJReiBpR5WzyiGC8uW5Rb5ToIG35Kcb7CW6" # Replace with your actual hash

        # Security headers for all services
        security-headers:
            headers:
                customRequestHeaders:
                    X-Forwarded-Proto: "https"
                customResponseHeaders:
                    X-Frame-Options: "SAMEORIGIN"
                    X-Content-Type-Options: "nosniff"
                    X-XSS-Protection: "1; mode=block"
                    Referrer-Policy: "strict-origin-when-cross-origin"
                    Permissions-Policy: "camera=(), microphone=(), geolocation=()"
                contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'"

        # Home Assistant specific headers
        home-assistant-headers:
            headers:
                customRequestHeaders:
                    X-Forwarded-Proto: "https"
                    X-Forwarded-For: ""
                    X-Real-IP: ""

        # Node-RED basic auth
        node-red-auth:
            basicAuth:
                users:
                    - "admin:$2y$10$..." # Replace with your actual hash

        # Rate limiting middleware (optional)
        rate-limit:
            rateLimit:
                burst: 100
                average: 50

        # CORS middleware (optional)
        cors:
            headers:
                accessControlAllowMethods:
                    - GET
                    - OPTIONS
                    - PUT
                    - POST
                    - DELETE
                accessControlAllowHeaders:
                    - "*"
                accessControlAllowOriginList:
                    - "https://cmnw.ru"
                    - "https://*.cmnw.ru"
                accessControlMaxAge: 100
                addVaryHeader: true

# TLS Configuration
tls:
    options:
        default:
            minVersion: "VersionTLS12"
            cipherSuites:
                - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
                - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
                - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
                - "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256"
            curvePreferences:
                - "CurveP521"
                - "CurveP384"
            sniStrict: true

# TCP/UDP routing (if needed)
tcp:
    routers: {}
    services: {}

udp:
    routers: {}
    services: {}
